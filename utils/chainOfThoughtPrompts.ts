import { ExtractedFinancialData } from '../types/financialStatements';

export class ChainOfThoughtPrompts {
  
  static createFinancialCalculationPrompt(structuredData: ExtractedFinancialData): string {
    const { statements } = structuredData;
    
    return `
あなたは財務分析の専門家です。以下の構造化された財務データに基づき、段階的に財務指標を計算してください。

## ステップ1: 基本財務指標の計算

提供された財務データ:
${JSON.stringify(statements, null, 2)}

以下の財務指標を正確に計算し、計算式も明記してください：

### 安全性分析:
1. **負債比率** = (負債合計 ÷ 純資産合計) × 100
   - 負債合計: ${statements.貸借対照表.負債の部.負債合計}千円
   - 純資産合計: ${statements.貸借対照表.純資産の部.純資産合計}千円
   - 計算: (${statements.貸借対照表.負債の部.負債合計} ÷ ${statements.貸借対照表.純資産の部.純資産合計}) × 100 = ?

2. **流動比率** = 流動資産合計 ÷ 流動負債合計
   - 流動資産合計: ${statements.貸借対照表.資産の部.流動資産.流動資産合計}千円
   - 流動負債合計: ${statements.貸借対照表.負債の部.流動負債.流動負債合計}千円
   - 計算: ${statements.貸借対照表.資産の部.流動資産.流動資産合計} ÷ ${statements.貸借対照表.負債の部.流動負債.流動負債合計} = ?

3. **固定比率** = 固定資産合計 ÷ 純資産合計
   - 固定資産合計: ${statements.貸借対照表.資産の部.固定資産.固定資産合計}千円
   - 純資産合計: ${statements.貸借対照表.純資産の部.純資産合計}千円
   - 計算: ${statements.貸借対照表.資産の部.固定資産.固定資産合計} ÷ ${statements.貸借対照表.純資産の部.純資産合計} = ?

### 収益性分析:
4. **経常利益（損失）**の確認:
   - 経常収益合計: ${statements.損益計算書.経常収益.経常収益合計}千円
   - 経常費用合計: ${statements.損益計算書.経常費用.経常費用合計}千円
   - 経常利益: ${statements.損益計算書.経常利益}千円
   - 当期純損失: ${statements.損益計算書.当期純損失 || 'なし'}千円

計算結果をJSON形式で出力してください：
{
  "財務指標": {
    "負債比率": "計算結果%",
    "流動比率": "計算結果",
    "固定比率": "計算結果",
    "経常利益": "数値",
    "当期純損失": "数値"
  },
  "計算過程": {
    "負債比率": "計算式と過程",
    "流動比率": "計算式と過程",
    "固定比率": "計算式と過程"
  }
}
`;
  }

  static createQualitativeAnalysisPrompt(
    structuredData: ExtractedFinancialData, 
    calculatedRatios: any
  ): string {
    const { statements } = structuredData;
    const segmentInfo = statements.セグメント情報;
    
    return `
## ステップ2: 定性分析

前ステップで計算された財務指標と構造化データに基づき、詳細な定性分析を行ってください。

### 計算済み財務指標:
${JSON.stringify(calculatedRatios, null, 2)}

### 構造化財務データ:
${JSON.stringify(statements, null, 2)}

以下の観点で財務分析を実施してください：

### 1. 収益性の課題分析:
- 経常損失の根本原因を特定してください
- **セグメント情報を必ず参照し、具体的な数値を引用してください**
${segmentInfo ? `- 特に、附属病院セグメントの業務損益（${segmentInfo.附属病院?.業務損益 || 'データなし'}千円）が法人全体の収益に与えている影響について具体的に論じてください` : '- セグメント情報が利用できません'}

### 2. 財務健全性の評価:
- 負債比率 ${calculatedRatios.財務指標?.負債比率}% の評価
- 流動比率 ${calculatedRatios.財務指標?.流動比率} の評価
- 固定比率の適切性について

### 3. キャッシュフローの評価:
- 投資活動によるキャッシュフロー: ${statements.キャッシュフロー計算書.投資活動によるキャッシュフロー.投資活動によるキャッシュフロー合計}千円
${statements.キャッシュフロー計算書.投資活動によるキャッシュフロー.有形固定資産の取得による支出 ? 
  `- 有形固定資産の取得による支出: ${statements.キャッシュフロー計算書.投資活動によるキャッシュフロー.有形固定資産の取得による支出}千円の影響について分析してください` : 
  '- 設備投資の詳細データが不足しています'}

### 4. リスク要因の特定:
- 財務構造上のリスク
- 収益構造上のリスク
- セグメント別のリスク

分析結果を以下の形式で出力してください：
{
  "収益性分析": "具体的な数値を引用した分析",
  "財務健全性分析": "計算された比率に基づく評価",
  "キャッシュフロー分析": "投資活動の影響を含む分析",
  "リスク要因": ["リスク1", "リスク2", "..."],
  "セグメント分析": "セグメント情報を活用した具体的分析"
}
`;
  }

  static createFinalReportPrompt(
    calculatedRatios: any, 
    qualitativeAnalysis: any
  ): string {
    return `
## ステップ3: 最終レポート生成

前の2つのステップで得られた結果を統合し、包括的な財務分析レポートを作成してください。

### 計算済み財務指標:
${JSON.stringify(calculatedRatios, null, 2)}

### 定性分析結果:
${JSON.stringify(qualitativeAnalysis, null, 2)}

以下の構成で最終レポートを作成してください：

## 財務分析レポート

### 1. エグゼクティブサマリー
- 財務状況の総合評価
- 主要な課題と機会

### 2. 財務指標分析
- 安全性指標の詳細評価
- 収益性指標の詳細評価
- 業界標準との比較（可能な場合）

### 3. セグメント別分析
- 各セグメントの収益貢献度
- 問題セグメントの特定と対策

### 4. キャッシュフロー分析
- 資金調達と投資活動の評価
- 将来の資金需要予測

### 5. リスク評価
- 短期的リスク
- 中長期的リスク
- リスク軽減策

### 6. 改善提案
- 具体的な改善アクション
- 優先順位付け
- 期待される効果

レポートは日本語で、財務の専門知識を持つ読者向けに作成してください。
数値は必ず具体的に引用し、根拠を明確にしてください。
`;
  }
}
